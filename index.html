<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Weather App</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
 <div class="card">

     <div class="search">
         <input type="text" class="search-input" placeholder="Enter City Name">
         <button class="search-btn">
             <img src="images/search.png" alt="">
         </button>
     </div>
     <div class="error">
         <p>Invalid city name</p>
     </div>

     <img src="https://media.tenor.com/2BLI5EO7yVAAAAAi/loading-image.gif" alt="" class="loading-img show">

     <div class="weather">
         <img src="images/snow.png" alt="" class="weather-img">
         <h1 class="temp">-----</h1>
         <h2 class="city">Moscow</h2>
         <div class="details">
             <div class="col">
                 <img src="images/humidity.png" alt="">
                 <div class="">
                     <p class="humidity">-----</p>
                     <p>Humidity</p>
                 </div>
             </div>
             <div class="col">
                 <img src="images/wind.png" alt="">
                 <div class="">
                     <p class="wind">----</p>
                     <p>Wind speed</p>
                 </div>
             </div>
         </div>
     </div>
 </div>


<script>
    //https://api.openweathermap.org/data/2.5/weather?units=metric&q=moscow&appid=ee8aec5438b85f81a428d68d05edfc82

    const apiKey = "ee8aec5438b85f81a428d68d05edfc82"
    const apiUrl = "https://api.openweathermap.org/data/2.5/weather?units=metric&q=";
    const searchBox = document.querySelector(".search input");
    const searchBtn = document.querySelector(".search button");
    const weatherIcon = document.querySelector(".weather-img");
    const loadingImg = document.querySelector(".loading-img");
    const weatherDiv = document.querySelector(".weather");
    const errorDiv = document.querySelector(".error");

    function showElement(element) {
        element.classList.add("show");
    }

    function hideElement(element) {
        element.classList.remove("show");
    }

    async function checkWeather(city) {
        // Показываем анимацию загрузки
        showElement(loadingImg);
        hideElement(weatherDiv);
        hideElement(errorDiv);
        const response = await fetch(apiUrl + city + `&appid=${apiKey}` ) ;
        if (response.status === 404){
            hideElement(loadingImg);
            showElement(errorDiv);
        } else {
            var data = await response.json();

            console.log(data);
            document.querySelector(".city").innerHTML = data.name;
            document.querySelector(".temp").innerHTML = Math.round(data.main.temp) + "℃";
            document.querySelector(".humidity").innerHTML = data.main.humidity+ "%";
            document.querySelector(".wind").innerHTML = Math.round(data.wind.speed)  + " km/h";

            var icon = data.weather[0].main;
            weatherIcon.src = "images/" + icon + ".png";
            setTimeout(() => {
                hideElement(loadingImg);
                showElement(weatherIcon);
                showElement(weatherDiv);
            }, 500);
        }
    }

    function getCityFromCoords() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(success, error);
        } else {
            console.log("Геолокация не поддерживается вашим браузером.");
        }
    }
    function success(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        showElement(loadingImg);
        console.log(`Широта: ${latitude}, Долгота: ${longitude}`);

        // Запрашиваем город через OpenStreetMap API
        fetchCityFromCoords(latitude, longitude);
    }
    function error() {
        console.log("Не удалось получить местоположение.");
    }
    function fetchCityFromCoords(lat, lon) {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.address) {
                    const city = data.address.city || data.address.town || data.address.village || "Город не найден";
                    console.log("Определенный город:", city);

                    // ✅ Сохраняем город в переменную и localStorage (опционально)
                    localStorage.setItem("userCity", city);

                    // Здесь можно вызвать свою функцию для отображения погоды
                    setTimeout(() => {
                        checkWeather(city);
                    }, 500);
                } else {
                    console.log("Не удалось определить город.");
                }
            })
            .catch(error => console.error("Ошибка при определении города:", error));
    }


    getCityFromCoords();

    searchBtn.addEventListener("click", () => {
        checkWeather(searchBox.value);
    })

</script>

</body>
</html>